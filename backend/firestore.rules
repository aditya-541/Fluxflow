rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validation functions
    function validateTaskData(data) {
      return data.title is string && data.title.size() > 0 && data.title.size() <= 200
        && data.estimatedDuration is number && data.estimatedDuration > 0 && data.estimatedDuration <= 480
        && data.priority is number && data.priority >= 1 && data.priority <= 5
        && data.completed is bool
        && data.createdAt is timestamp
        && (!('category' in data) || data.category in ['deep-work', 'admin', 'creative', 'physical', 'personal']);
    }
    
    function validateEnergyLog() {
      let data = request.resource.data;
      return data.keys().hasAll(['level', 'timestamp'])
        && data.level is int
        && data.level >= 1
        && data.level <= 10
        && data.timestamp is timestamp;
    }
    
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['settings', 'updatedAt']);
      
      match /tasks/{taskId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateTaskData();
        allow update: if isOwner(userId) && validateTaskData();
        allow delete: if isOwner(userId);
      }
      
      match /energy_logs/{logId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateEnergyLog();
        // Energy logs should not be updated or deleted
        allow update, delete: if false;
      }
    }
  }
}

